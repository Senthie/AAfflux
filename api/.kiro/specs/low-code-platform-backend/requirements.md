# 需求文档

## 简介

本系统是一个类似于 Dify 的低代码平台后端，旨在为用户提供可视化的工作流编排、AI 应用构建和管理能力。系统支持用户通过拖拽节点的方式创建复杂的 AI 工作流，管理提示词模板，配置 LLM 模型，并提供 API 接口供前端调用。

## 术语表

- **系统 (System)**: 指低代码平台后端服务
- **用户 (User)**: 使用平台创建和管理 AI 应用的开发者或业务人员
- **工作流 (Workflow)**: 由多个节点组成的有向无环图，定义了数据处理和 AI 调用的流程
- **节点 (Node)**: 工作流中的基本执行单元，可以是 LLM 调用、条件判断、数据转换等
- **应用 (Application)**: 用户创建的 AI 应用实例，包含工作流配置和运行时设置
- **提示词模板 (Prompt Template)**: 可复用的提示词配置，支持变量替换
- **LLM 提供商 (LLM Provider)**: 提供大语言模型服务的第三方平台，如 OpenAI、Anthropic 等
- **执行记录 (Execution Record)**: 工作流执行的历史记录，包含输入、输出和中间状态
- **团队 (Team)**: 多个用户组成的协作单位，共享资源和权限
- **企业 (Organization)**: 包含多个团队的顶层组织结构
- **角色 (Role)**: 定义用户在团队或企业中的权限级别，如管理员、成员、访客等
- **工作空间 (Workspace)**: 团队或企业的资源隔离单元，包含工作流、应用等资源

## 需求

### 需求 1

**用户故事:** 作为用户，我想要注册和登录系统，以便访问平台功能

#### 验收标准

1. WHEN 用户提交注册信息时 THEN 系统 SHALL 验证邮箱格式和密码强度并创建用户账户
2. WHEN 用户使用邮箱和密码登录时 THEN 系统 SHALL 验证凭证并生成访问令牌
3. WHEN 用户访问令牌过期时 THEN 系统 SHALL 拒绝请求并返回 401 状态码
4. WHEN 用户请求刷新令牌时 THEN 系统 SHALL 验证刷新令牌并生成新的访问令牌
5. WHEN 用户登出时 THEN 系统 SHALL 撤销当前访问令牌和刷新令牌

### 需求 2

**用户故事:** 作为用户，我想要管理个人资料，以便更新账户信息

#### 验收标准

1. WHEN 用户更新个人资料时 THEN 系统 SHALL 验证新信息的有效性并保存更改
2. WHEN 用户修改密码时 THEN 系统 SHALL 验证旧密码并更新为新密码
3. WHEN 用户上传头像时 THEN 系统 SHALL 验证图片格式和大小并保存头像
4. WHEN 用户请求重置密码时 THEN 系统 SHALL 发送重置链接到注册邮箱
5. WHEN 用户通过重置链接设置新密码时 THEN 系统 SHALL 验证链接有效性并更新密码

### 需求 3

**用户故事:** 作为用户，我想要创建和管理团队，以便与他人协作

#### 验收标准

1. WHEN 用户创建团队时 THEN 系统 SHALL 生成唯一的团队标识符并将创建者设为团队管理员
2. WHEN 团队管理员邀请成员时 THEN 系统 SHALL 发送邀请链接到指定邮箱
3. WHEN 用户接受团队邀请时 THEN 系统 SHALL 将用户添加到团队并分配默认角色
4. WHEN 团队管理员移除成员时 THEN 系统 SHALL 撤销该成员对团队资源的访问权限
5. WHEN 团队管理员更改成员角色时 THEN 系统 SHALL 更新成员的权限并立即生效

### 需求 4

**用户故事:** 作为企业管理员，我想要创建和管理企业组织，以便统一管理多个团队

#### 验收标准

1. WHEN 用户创建企业时 THEN 系统 SHALL 生成唯一的企业标识符并将创建者设为企业管理员
2. WHEN 企业管理员创建团队时 THEN 系统 SHALL 将团队关联到企业并继承企业配置
3. WHEN 企业管理员设置企业级配置时 THEN 系统 SHALL 将配置应用到所有关联的团队
4. WHEN 企业管理员查看使用统计时 THEN 系统 SHALL 汇总所有团队的资源使用情况
5. WHEN 企业管理员删除团队时 THEN 系统 SHALL 移除团队及其所有资源

### 需求 5

**用户故事:** 作为团队成员，我想要系统根据角色控制访问权限，以便保护团队资源

#### 验收标准

1. WHEN 用户访问团队资源时 THEN 系统 SHALL 验证用户的角色权限
2. WHEN 用户尝试执行超出权限的操作时 THEN 系统 SHALL 拒绝请求并返回 403 状态码
3. WHEN 管理员角色用户操作时 THEN 系统 SHALL 允许创建、读取、更新和删除所有团队资源
4. WHEN 成员角色用户操作时 THEN 系统 SHALL 允许创建和读取资源但限制删除操作
5. WHEN 访客角色用户操作时 THEN 系统 SHALL 仅允许读取公开的团队资源

### 需求 6

**用户故事:** 作为用户，我想要在工作空间中组织资源，以便隔离不同项目的工作流和应用

#### 验收标准

1. WHEN 用户创建工作空间时 THEN 系统 SHALL 生成唯一的工作空间标识符并关联到团队
2. WHEN 用户在工作空间中创建资源时 THEN 系统 SHALL 将资源关联到该工作空间
3. WHEN 用户切换工作空间时 THEN 系统 SHALL 仅显示当前工作空间的资源
4. WHEN 用户在工作空间间移动资源时 THEN 系统 SHALL 验证权限并更新资源的工作空间关联
5. WHEN 用户删除工作空间时 THEN 系统 SHALL 移除工作空间及其所有关联资源

### 需求 7

**用户故事:** 作为用户，我想要创建和管理工作流，以便构建自定义的 AI 应用流程

#### 验收标准

1. WHEN 用户在工作空间中创建新工作流时 THEN 系统 SHALL 生成唯一的工作流标识符并初始化空的节点列表
2. WHEN 用户向工作流添加节点时 THEN 系统 SHALL 验证节点配置的完整性并将节点添加到工作流中
3. WHEN 用户连接两个节点时 THEN 系统 SHALL 验证连接不会形成循环依赖
4. WHEN 用户保存工作流时 THEN 系统 SHALL 验证工作流的完整性并持久化到存储中
5. WHEN 用户删除工作流时 THEN 系统 SHALL 移除工作流及其所有关联的执行记录

### 需求 8

**用户故事:** 作为用户，我想要执行工作流，以便处理输入数据并获得结果

#### 验收标准

1. WHEN 用户提交工作流执行请求时 THEN 系统 SHALL 验证输入参数与工作流定义的输入变量匹配
2. WHEN 工作流开始执行时 THEN 系统 SHALL 按照拓扑排序的顺序执行各个节点
3. WHEN 节点执行完成时 THEN 系统 SHALL 将输出传递给所有依赖该节点的后续节点
4. WHEN 工作流执行完成时 THEN 系统 SHALL 返回最终输出结果并创建执行记录
5. WHEN 工作流执行过程中发生错误时 THEN 系统 SHALL 停止执行、记录错误信息并返回错误响应

### 需求 9

**用户故事:** 作为用户，我想要管理提示词模板，以便在多个工作流中复用提示词配置

#### 验收标准

1. WHEN 用户创建提示词模板时 THEN 系统 SHALL 验证模板语法并保存模板内容
2. WHEN 用户在模板中使用变量占位符时 THEN 系统 SHALL 支持 {{variable_name}} 格式的变量定义
3. WHEN 用户渲染提示词模板时 THEN 系统 SHALL 将提供的变量值替换到模板中的占位符
4. WHEN 用户更新提示词模板时 THEN 系统 SHALL 保存新版本并保留历史版本
5. WHEN 用户删除提示词模板时 THEN 系统 SHALL 检查是否有工作流正在使用该模板并阻止删除

### 需求 10

**用户故事:** 作为用户，我想要配置和管理 LLM 提供商，以便在工作流中调用不同的语言模型

#### 验收标准

1. WHEN 用户添加 LLM 提供商配置时 THEN 系统 SHALL 验证 API 密钥的有效性并保存配置
2. WHEN 用户选择 LLM 模型时 THEN 系统 SHALL 提供该提供商支持的模型列表
3. WHEN 工作流节点调用 LLM 时 THEN 系统 SHALL 使用配置的 API 密钥向提供商发送请求
4. WHEN LLM 调用失败时 THEN 系统 SHALL 记录错误详情并根据配置决定是否重试
5. WHEN 用户删除 LLM 提供商配置时 THEN 系统 SHALL 检查是否有工作流正在使用该配置并阻止删除

### 需求 11

**用户故事:** 作为用户，我想要查看工作流的执行历史，以便调试和优化工作流

#### 验收标准

1. WHEN 用户查询执行记录时 THEN 系统 SHALL 返回指定工作流的所有执行历史
2. WHEN 用户查看单个执行记录时 THEN 系统 SHALL 显示输入参数、输出结果和每个节点的执行状态
3. WHEN 执行记录包含错误时 THEN 系统 SHALL 显示错误发生的节点和详细错误信息
4. WHEN 用户按时间范围筛选执行记录时 THEN 系统 SHALL 返回指定时间范围内的记录
5. WHEN 执行记录超过保留期限时 THEN 系统 SHALL 自动清理过期的执行记录

### 需求 12

**用户故事:** 作为用户，我想要管理应用，以便组织和发布我的 AI 工作流

#### 验收标准

1. WHEN 用户创建应用时 THEN 系统 SHALL 生成唯一的应用标识符并关联到指定的工作流
2. WHEN 用户发布应用时 THEN 系统 SHALL 生成 API 端点供外部系统调用
3. WHEN 外部系统调用应用 API 时 THEN 系统 SHALL 验证 API 密钥并执行关联的工作流
4. WHEN 用户更新应用配置时 THEN 系统 SHALL 保存新配置并立即生效
5. WHEN 用户删除应用时 THEN 系统 SHALL 撤销 API 端点并移除应用数据

### 需求 13

**用户故事:** 作为用户，我想要系统支持不同类型的节点，以便构建灵活的工作流

#### 验收标准

1. WHEN 用户添加 LLM 节点时 THEN 系统 SHALL 支持配置模型、提示词、温度和最大令牌数
2. WHEN 用户添加条件节点时 THEN 系统 SHALL 支持基于表达式的条件判断和分支路由
3. WHEN 用户添加代码节点时 THEN 系统 SHALL 支持执行 Python 代码并返回结果
4. WHEN 用户添加 HTTP 请求节点时 THEN 系统 SHALL 支持发送 HTTP 请求并处理响应
5. WHEN 用户添加数据转换节点时 THEN 系统 SHALL 支持 JSON 路径提取和数据格式转换

### 需求 14

**用户故事:** 作为系统管理员，我想要系统具有良好的错误处理和日志记录，以便监控和排查问题

#### 验收标准

1. WHEN 系统处理请求时 THEN 系统 SHALL 记录请求的关键信息到日志中
2. WHEN 系统发生错误时 THEN 系统 SHALL 记录完整的错误堆栈和上下文信息
3. WHEN 系统调用外部服务失败时 THEN 系统 SHALL 记录请求和响应的详细信息
4. WHEN 系统执行工作流时 THEN 系统 SHALL 记录每个节点的执行时间和状态
5. WHEN 系统资源使用异常时 THEN 系统 SHALL 记录警告信息并触发告警

### 需求 15

**用户故事:** 作为用户，我想要系统支持数据持久化，以便保存和恢复工作流配置

#### 验收标准

1. WHEN 用户保存工作流时 THEN 系统 SHALL 将工作流配置序列化为 JSON 格式并存储
2. WHEN 用户加载工作流时 THEN 系统 SHALL 从存储中反序列化 JSON 并重建工作流对象
3. WHEN 序列化工作流时 THEN 系统 SHALL 包含所有节点配置、连接关系和元数据
4. WHEN 反序列化工作流时 THEN 系统 SHALL 验证 JSON 结构的完整性和正确性
5. WHEN 数据格式版本升级时 THEN 系统 SHALL 支持向后兼容的数据迁移

### 需求 16

**用户故事:** 作为用户，我想要系统提供 RESTful API，以便前端和第三方系统集成

#### 验收标准

1. WHEN 客户端发送 API 请求时 THEN 系统 SHALL 验证请求格式和认证信息
2. WHEN API 请求成功时 THEN 系统 SHALL 返回 JSON 格式的响应和适当的 HTTP 状态码
3. WHEN API 请求失败时 THEN 系统 SHALL 返回包含错误代码和错误消息的 JSON 响应
4. WHEN API 接收到无效参数时 THEN 系统 SHALL 返回 400 状态码和参数验证错误详情
5. WHEN API 处理请求超时时 THEN 系统 SHALL 返回 504 状态码并记录超时信息
